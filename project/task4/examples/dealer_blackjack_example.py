"""
–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä, –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–∏—Ç—É–∞—Ü–∏–∏ —Å –±–ª—ç–∫–¥–∂–µ–∫–æ–º —É –¥–∏–ª–µ—Ä–∞.
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ –∏–≥—Ä–∞ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ —ç—Ç—É –æ—Å–æ–±—É—é —Å–∏—Ç—É–∞—Ü–∏—é.
"""
import os
import sys

sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from core.game import Game
from core.deck import Deck
from core.card import Card
from strategies.conservative import ConservativeStrategy
from strategies.aggressive import AggressiveStrategy


class GuaranteedBlackjackDeck(Deck):
    """–ö–æ–ª–æ–¥–∞, –∫–æ—Ç–æ—Ä–∞—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –±–ª—ç–∫–¥–∂–µ–∫ –¥–∏–ª–µ—Ä—É –≤–æ –≤—Ç–æ—Ä–æ–º —Ä–∞—É–Ω–¥–µ"""

    def __init__(self, num_decks=1):
        super().__init__(num_decks)
        self.current_round = 0
        self.card_count = 0
        self.blackjack_round_cards = None
        self._prepare_blackjack_cards()

    def _prepare_blackjack_cards(self):
        """–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–∞—Ä—Ç –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –±–ª—ç–∫–¥–∂–µ–∫–∞ –¥–∏–ª–µ—Ä–∞"""
        # –î–ª—è –≤—Ç–æ—Ä–æ–≥–æ —Ä–∞—É–Ω–¥–∞: –¥–∏–ª–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç A –∏ 10 (–±–ª—ç–∫–¥–∂–µ–∫)
        # –ò–≥—Ä–æ–∫–∏ –ø–æ–ª—É—á–∞—é—Ç –∫–∞—Ä—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –¥–∞—é—Ç –±–ª—ç–∫–¥–∂–µ–∫
        self.blackjack_round_cards = [
            # –ü–µ—Ä–≤—ã–µ –∫–∞—Ä—Ç—ã –∏–≥—Ä–æ–∫–æ–≤
            Card("Hearts", "7", 7),  # –ò–≥—Ä–æ–∫1 –ø–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–∞
            Card("Diamonds", "8", 8),  # –ò–≥—Ä–æ–∫2 –ø–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–∞
            # –ü–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–∞ –¥–∏–ª–µ—Ä–∞ (–æ—Ç–∫—Ä—ã—Ç–∞—è) - –¢–£–ó
            Card("Spades", "A", 11),
            # –í—Ç–æ—Ä—ã–µ –∫–∞—Ä—Ç—ã –∏–≥—Ä–æ–∫–æ–≤
            Card("Hearts", "9", 9),  # –ò–≥—Ä–æ–∫1 –≤—Ç–æ—Ä–∞—è –∫–∞—Ä—Ç–∞
            Card("Diamonds", "6", 6),  # –ò–≥—Ä–æ–∫2 –≤—Ç–æ—Ä–∞—è –∫–∞—Ä—Ç–∞
            # –í—Ç–æ—Ä–∞—è –∫–∞—Ä—Ç–∞ –¥–∏–ª–µ—Ä–∞ (—Å–∫—Ä—ã—Ç–∞—è) - 10
            Card("Spades", "K", 10),
        ]

    def start_new_round(self):
        """–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ä–∞—É–Ω–¥–∞"""
        self.current_round += 1
        self.card_count = 0
        print(f"üî¢ –ù–∞—á–∞–ª–æ —Ä–∞—É–Ω–¥–∞ {self.current_round}, —Å–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ –∫–∞—Ä—Ç")

    def deal_card(self):
        """–í—ã–¥–∞—á–∞ –∫–∞—Ä—Ç—ã —Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –±–ª—ç–∫–¥–∂–µ–∫–æ–º –≤–æ –≤—Ç–æ—Ä–æ–º —Ä–∞—É–Ω–¥–µ"""
        self.card_count += 1

        # –î–ª—è –≤—Ç–æ—Ä–æ–≥–æ —Ä–∞—É–Ω–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–π —Ä–∞–∑–¥–∞—á–∏
        if self.current_round == 2 and self.card_count <= len(
            self.blackjack_round_cards
        ):
            card = self.blackjack_round_cards[self.card_count - 1]
            print(
                f"üéØ –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–∞—è –≤—ã–¥–∞—á–∞: {card} (–∫–∞—Ä—Ç–∞ #{self.card_count} –≤ —Ä–∞—É–Ω–¥–µ {self.current_round})"
            )
            return card

        # –î–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—É—é –ª–æ–≥–∏–∫—É
        card = super().deal_card()
        print(
            f"üé≤ –°–ª—É—á–∞–π–Ω–∞—è –∫–∞—Ä—Ç–∞: {card} (–∫–∞—Ä—Ç–∞ #{self.card_count} –≤ —Ä–∞—É–Ω–¥–µ {self.current_round})"
        )
        return card


class BlackjackDemoGame(Game):
    """–°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –∏–≥—Ä—ã –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –±–ª—ç–∫–¥–∂–µ–∫–∞ –¥–∏–ª–µ—Ä–∞"""

    def __init__(self, num_decks=1, max_rounds=2):
        super().__init__(num_decks, max_rounds)
        # –ó–∞–º–µ–Ω—è–µ–º –∫–æ–ª–æ–¥—É –Ω–∞ –Ω–∞—à—É –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—É—é –≤–µ—Ä—Å–∏—é
        self.deck = GuaranteedBlackjackDeck(num_decks)

    def play_round(self):
        """–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ —Ä–∞—É–Ω–¥–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–π –∫–æ–ª–æ–¥—ã"""
        if not self.is_game_active or self.current_round >= self.max_rounds:
            return {"game_over": True}

        # –°–æ–æ–±—â–∞–µ–º –∫–æ–ª–æ–¥–µ –æ –Ω–∞—á–∞–ª–µ –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞
        self.deck.start_new_round()

        self.current_round += 1
        round_info = {
            "round": self.current_round,
            "bets": [],
            "card_dealing": [],
            "player_turns": [],
            "dealer_turn": {},
            "results": [],
            "final_state": {},
        }

        print(f"\n{'='*60}")
        print(f"üé∞ –†–ê–£–ù–î {self.current_round}")
        print(f"{'='*60}")

        # –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏–π
        self._reset_round()

        # –°—Ç–∞–≤–∫–∏
        self._place_bets(round_info)

        # –†–∞–∑–¥–∞—á–∞ –∫–∞—Ä—Ç
        self._deal_initial_cards(round_info)

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª—ç–∫–¥–∂–µ–∫–∞ —É –¥–∏–ª–µ—Ä–∞
        if self._check_dealer_blackjack(round_info):
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            round_info["final_state"] = self.get_game_state()
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞—É–Ω–¥ –≤ –∏—Å—Ç–æ—Ä–∏—é
            self._save_round_to_history(round_info)
            return round_info

        # –•–æ–¥—ã –∏–≥—Ä–æ–∫–æ–≤
        self._play_players_turns(round_info)

        # –•–æ–¥ –¥–∏–ª–µ—Ä–∞
        self._play_dealer_turn(round_info)

        # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
        self._determine_winners(round_info)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        round_info["final_state"] = self.get_game_state()

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞—É–Ω–¥ –≤ –∏—Å—Ç–æ—Ä–∏—é
        self._save_round_to_history(round_info)

        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
        self._check_game_status()

        return round_info


def run_dealer_blackjack_example():
    """–ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–ª—ç–∫–¥–∂–µ–∫–∞ —É –¥–∏–ª–µ—Ä–∞ —Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Å—Ü–µ–Ω–∞—Ä–∏–µ–º"""
    print("=" * 80)
    print("–ü–†–ò–ú–ï–†: BLACKJACK –£ –î–ò–õ–ï–†–ê (–ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–´–ô)")
    print("=" * 80)
    print("–≠—Ç–æ—Ç –ø—Ä–∏–º–µ—Ä —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Å–∏—Ç—É–∞—Ü–∏–∏,")
    print("–∫–æ–≥–¥–∞ —É –¥–∏–ª–µ—Ä–∞ –≤—ã–ø–∞–¥–∞–µ—Ç –±–ª—ç–∫–¥–∂–µ–∫, –∏ –∫–∞–∫ —ç—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –∏–≥—Ä—É.")
    print("–í–æ –≤—Ç–æ—Ä–æ–º —Ä–∞—É–Ω–¥–µ –¥–∏–ª–µ—Ä –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–û –ø–æ–ª—É—á–∞–µ—Ç –±–ª—ç–∫–¥–∂–µ–∫.")
    print("=" * 80)

    # –°–æ–∑–¥–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –∏–≥—Ä—É –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
    game = BlackjackDemoGame(num_decks=1, max_rounds=2)

    # –î–æ–±–∞–≤–ª—è–µ–º –∏–≥—Ä–æ–∫–æ–≤
    game.add_bot("–ò–≥—Ä–æ–∫1", ConservativeStrategy(), 500)
    game.add_bot("–ò–≥—Ä–æ–∫2", AggressiveStrategy(), 500)

    game.start_game()

    print("\nüé∞ –†–ê–£–ù–î 1 - –û–ë–´–ß–ù–ê–Ø –°–ò–¢–£–ê–¶–ò–Ø")
    print("-" * 40)
    print("–í —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ –∫–∞—Ä—Ç—ã —Ä–∞–∑–¥–∞—é—Ç—Å—è —Å–ª—É—á–∞–π–Ω–æ, –∫–∞–∫ –≤ –æ–±—ã—á–Ω–æ–π –∏–≥—Ä–µ.")
    game.play_round()

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç—á–µ—Ç –ø–æ –ø–µ—Ä–≤–æ–º—É —Ä–∞—É–Ω–¥—É
    game.show_round_report(1)

    # –í—Ç–æ—Ä–æ–π —Ä–∞—É–Ω–¥ - –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–ª—ç–∫–¥–∂–µ–∫ –¥–∏–ª–µ—Ä–∞
    print(f"\n{'='*80}")
    print("üé∞ –†–ê–£–ù–î 2 - –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–´–ô BLACKJACK –£ –î–ò–õ–ï–†–ê")
    print(f"{'='*80}")

    print("\nüí• –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–ê–Ø –°–ò–¢–£–ê–¶–ò–Ø: –£ –î–ò–õ–ï–†–ê BLACKJACK!")
    print("–í —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ –¥–∏–ª–µ—Ä –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç:")
    print("   ‚Ä¢ –ü–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–∞: A of Spades ‚ô†")
    print("   ‚Ä¢ –í—Ç–æ—Ä–∞—è –∫–∞—Ä—Ç–∞: K of Spades ‚ô†")
    print("–≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞—É–Ω–¥ –∏ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤.")
    print("\n–ü–†–ê–í–ò–õ–ê –ü–†–ò BLACKJACKE –î–ò–õ–ï–†–ê:")
    print("‚Ä¢ –ò–≥—Ä–æ–∫–∏ —Å –±–ª—ç–∫–¥–∂–µ–∫–æ–º –ø–æ–ª—É—á–∞—é—Ç –≤–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞–≤–∫–∏ (–Ω–∏—á—å—è)")
    print("‚Ä¢ –ò–≥—Ä–æ–∫–∏ –±–µ–∑ –±–ª—ç–∫–¥–∂–µ—Ä–∞ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—é—Ç —Å–≤–æ–∏ —Å—Ç–∞–≤–∫–∏")
    print("‚Ä¢ –î–∞–ª—å–Ω–µ–π—à–∏–µ —Ö–æ–¥—ã –∏–≥—Ä–æ–∫–æ–≤ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç")

    # –ò–≥—Ä–∞–µ–º –≤—Ç–æ—Ä–æ–π —Ä–∞—É–Ω–¥ —Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –±–ª—ç–∫–¥–∂–µ–∫–æ–º –¥–∏–ª–µ—Ä–∞
    game.play_round()

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç—á–µ—Ç
    game.show_round_report(2)

    print(f"\n{'='*80}")
    print("–ê–ù–ê–õ–ò–ó –í–õ–ò–Ø–ù–ò–Ø BLACKJACKA –î–ò–õ–ï–†–ê")
    print(f"{'='*80}")

    final_state = game.get_game_state()

    print(f"\nüìä –°–†–ê–í–ù–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í:")
    for player in final_state["players"]:
        # –ù–∞—Ö–æ–¥–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤—Ç–æ—Ä–æ–≥–æ —Ä–∞—É–Ω–¥–∞
        if len(game.round_history) >= 2:
            after_round1 = game.round_history[0]["final_state"]
            player_after_1 = next(
                (p for p in after_round1["players"] if p["name"] == player["name"]),
                None,
            )

            if player_after_1:
                change_round2 = player["chips"] - player_after_1["chips"]
                trend = "üìà" if change_round2 > 0 else "üìâ" if change_round2 < 0 else "‚û°Ô∏è"
                print(
                    f"   {trend} {player['name']}: {player['chips']} —Ñ–∏—à–µ–∫ (–∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤–æ 2 —Ä–∞—É–Ω–¥–µ: {change_round2:+})"
                )

    print(f"\nüìù –î–ï–¢–ê–õ–ò –í–¢–û–†–û–ì–û –†–ê–£–ù–î–ê:")
    print("   ‚Ä¢ –î–∏–ª–µ—Ä –ø–æ–ª—É—á–∏–ª: A of Spades ‚ô† –∏ K of Spades ‚ô† = BLACKJACK!")
    print("   ‚Ä¢ –ò–≥—Ä–æ–∫1 –ø–æ–ª—É—á–∏–ª: 7 of Hearts ‚ô• –∏ 9 of Hearts ‚ô• (—Å—É–º–º–∞: 16)")
    print("   ‚Ä¢ –ò–≥—Ä–æ–∫2 –ø–æ–ª—É—á–∏–ª: 8 of Diamonds ‚ô¶ –∏ 6 of Diamonds ‚ô¶ (—Å—É–º–º–∞: 14)")
    print("   ‚Ä¢ –û–±–∞ –∏–≥—Ä–æ–∫–∞ –ø—Ä–æ–∏–≥—Ä–∞–ª–∏, —Ç–∞–∫ –∫–∞–∫ —É –¥–∏–ª–µ—Ä–∞ –±–ª—ç–∫–¥–∂–µ–∫")

    print(f"\nüí° –í–´–í–û–î–´:")
    print("   ‚Ä¢ Blackjack –¥–∏–ª–µ—Ä–∞ - –º–æ—â–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ, –≤–ª–∏—è—é—â–µ–µ –Ω–∞ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤")
    print("   ‚Ä¢ –ò–≥—Ä–æ–∫–∏ –Ω–µ –º–æ–≥—É—Ç –Ω–∏—á–µ–≥–æ —Å–¥–µ–ª–∞—Ç—å –ø—Ä–æ—Ç–∏–≤ blackjack'–∞ –¥–∏–ª–µ—Ä–∞")
    print("   ‚Ä¢ –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞ - —Ç–æ–∂–µ –∏–º–µ—Ç—å blackjack –¥–ª—è –Ω–∏—á—å–µ–π")
    print("   ‚Ä¢ –≠—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —ç–ª–µ–º–µ–Ω—Ç —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏ –≤ –∏–≥—Ä–µ")
    print("   ‚Ä¢ –í –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–µ —Ç–∞–∫–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏ —É—Ä–∞–≤–Ω–æ–≤–µ—à–∏–≤–∞—é—Ç—Å—è")


if __name__ == "__main__":
    run_dealer_blackjack_example()
